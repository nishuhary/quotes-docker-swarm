const test = require('tape')
const http = require('http')
const fs = require('fs')
const bl = require('bl')
const xtend = require('xtend')
const EE = require('events').EventEmitter
const jsonist = require('./')
const stringify = require('json-stringify-safe')
const after = require('after')

function testServer (serverResponse, statusCode) {
  const ee = new EE()
  const server = http.createServer(handler)

  function handler (req, res) {
    req.pipe(bl(function (err, data) {
      if (err) { return ee.emit('error', err) }

      ee.emit('request', req, data.toString())

      setTimeout(server.close.bind(server), 20)
    }))

    res.writeHead(
      typeof statusCode === 'number' ? statusCode : 200
      , { 'content-type': 'application/json' }
    )
    res.end(serverResponse || '')
  }

  server.listen(function () {
    ee.emit('ready', 'http://localhost:' + server.address().port)
  })

  server.on('close', ee.emit.bind(ee, 'close'))

  return ee
}

'get delete'.split(' ').forEach((type) => {
  test(type 